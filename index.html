<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ˆç•«è¡¨</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 1.5rem auto; padding: 0 1rem; background-color: #f0f2f5; color: #333; }
        
        h1 { text-align: center; margin-bottom: 10px; color: #2c3e50; font-size: 1.5rem; }
        
        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .date-row { 
            font-size: 1.1rem; 
            opacity: 0.9; 
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .weekday-row { 
            font-size: 2rem; 
            font-weight: bold; 
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .countdown-box {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            display: inline-block;
            width: 100%;
            box-sizing: border-box;
        }
        .countdown-text { font-size: 1.1rem; margin-bottom: 2px; }
        .countdown-text span { color: #ffd700; font-size: 1.3rem; font-weight: bold; padding: 0 4px;}
        .target-label { font-size: 0.75rem; opacity: 0.85; }

        .input-group { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; outline: none; }
        button#add-btn { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button#add-btn:hover { background-color: #0056b3; }

        ul { list-style: none; padding: 0; }
        li { background: white; border-bottom: 1px solid #eee; padding: 15px; display: flex; align-items: center; justify-content: space-between; gap: 10px; transition: all 0.2s; }
        li:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        li:last-child { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border-bottom: none; }
        
        .task-content { flex: 1; cursor: pointer; display: flex; align-items: center; font-size: 1.1rem; }
        .checkbox-custom { width: 20px; height: 20px; border: 2px solid #007bff; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        
        .completed .task-content { text-decoration: line-through; color: #aaa; }
        .completed .checkbox-custom { background-color: #007bff; border-color: #007bff; }
        .completed .checkbox-custom::after { content: 'âœ”'; color: white; font-size: 12px; }

        .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-right: 8px; font-weight: bold; flex-shrink: 0; }
        .tag-past { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; } 
        
        .delete-btn { background: transparent; color: #dc3545; border: 1px solid #dc3545; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; opacity: 0.6; }
        .delete-btn:hover { opacity: 1; background: #dc3545; color: white; }

        .loading { text-align: center; color: #888; margin-top: 20px; font-size: 0.9rem;}
    </style>
</head>
<body>

    <h1>ğŸ“… è¨ˆç•«è¡¨</h1>
    
    <div class="info-card">
        <div class="date-row" id="fullDateDisplay">...</div>
        
        <div class="weekday-row" id="weekdayDisplay">...</div>
        
        <div class="countdown-box">
            <div class="countdown-text" id="countdownDisplay">è¨ˆç®—ä¸­...</div>
            <div class="target-label">ğŸ¯ ç›®æ¨™ï¼š2026/07/11 (æ±ºæˆ°æ—¥)</div>
        </div>
    </div>
    
    <div class="input-group">
        <input type="text" id="taskInput" placeholder="è¼¸å…¥ä»»å‹™..." onkeypress="handleEnter(event)">
        <button id="add-btn" onclick="addTask()">æŒ‡æ´¾</button>
    </div>

    <div id="status-msg" class="loading">é€£ç·šè³‡æ–™åº«ä¸­...</div>
    <ul id="taskList"></ul>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDARnJvl6MOtpWcH2fVbmVT7pV2T5y-RKI",
            authDomain: "weekly-todo-app-dc60e.firebaseapp.com",
            databaseURL: "https://weekly-todo-app-dc60e-default-rtdb.firebaseio.com",
            projectId: "weekly-todo-app-dc60e",
            storageBucket: "weekly-todo-app-dc60e.firebasestorage.app",
            messagingSenderId: "746521986244",
            appId: "1:746521986244:web:1a113919a35f8bba7c3591",
            measurementId: "G-WLRG3M8MC8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tasksRef = ref(db, 'tasks');


        function updateDateAndCountdown() {
            const now = new Date();
            const targetDate = new Date('2026-07-11T00:00:00'); 

            const dateStr = now.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('fullDateDisplay').innerText = dateStr;

            const weekdayStr = now.toLocaleDateString('zh-TW', { weekday: 'long' });
            document.getElementById('weekdayDisplay').innerText = weekdayStr;

            const diffTime = targetDate - now;
            if (diffTime > 0) {
                const diffDaysTotal = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const weeks = Math.floor(diffDaysTotal / 7);
                const days = diffDaysTotal % 7;
                
                document.getElementById('countdownDisplay').innerHTML = 
                    `è·é›¢ç›®æ¨™é‚„æœ‰ <span>${weeks}</span> é€± <span>${days}</span> å¤©`;
            } else {
                document.getElementById('countdownDisplay').innerText = "æ™‚é–“åˆ°ï¼é©—æ”¶æˆæœçš„æ™‚å€™äº†ï¼";
            }
        }
        
        updateDateAndCountdown();
        setInterval(updateDateAndCountdown, 60000); 

        function getCurrentWeekID() {
            const d = new Date();

            const dayNum = d.getDay() || 7; 
            d.setHours(0, 0, 0, 0);

            d.setDate(d.getDate() + 4 - dayNum);
            const year = d.getFullYear();
            const startOfYear = new Date(year, 0, 1);

            const weekNo = Math.ceil((((d - startOfYear) / 86400000) + 1) / 7);
            return `${year}-W${weekNo.toString().padStart(2, '0')}`;
        }
        const currentWeekID = getCurrentWeekID();
        console.log("Current Week ID:", currentWeekID); // ç”¨æ–¼é™¤éŒ¯

        onValue(tasksRef, (snapshot) => {
            const msgDiv = document.getElementById('status-msg');
            msgDiv.style.display = 'none';
            
            const data = snapshot.val();
            const list = document.getElementById('taskList');
            list.innerHTML = '';

            if (!data) {
                msgDiv.innerText = "æœ¬é€±å°šæœªå®‰æ’ä»»å‹™";
                msgDiv.style.display = 'block';
                return;
            }

            const tasks = Object.keys(data).map(key => ({
                id: key,
                ...data[key]
            }));


            const tasksToShow = tasks.filter(task => {
                const isCurrentWeek = task.weekId === currentWeekID;
                const isPastUnfinished = (task.weekId < currentWeekID) && !task.done;
                return isCurrentWeek || isPastUnfinished;
            });

            if (tasksToShow.length === 0) {
                msgDiv.innerText = "å¤ªæ£’äº†ï¼æ‰€æœ‰ä»»å‹™çš†å·²å®Œæˆ ğŸ‰";
                msgDiv.style.display = 'block';
            }


            tasksToShow.sort((a, b) => {

                if (a.done !== b.done) {
                    return a.done - b.done; 
                }
                

                if (a.weekId !== b.weekId) {
                    return b.weekId.localeCompare(a.weekId);
                }
                return b.createdAt - a.createdAt; 
            });

            tasksToShow.forEach(task => {
                const li = document.createElement('li');
                li.className = task.done ? 'completed' : '';
                
                const isRollover = task.weekId < currentWeekID;
                const tagHtml = isRollover 
                    ? `<span class="tag tag-past">å»¶çºŒ</span>` 
                    : ``;

                li.innerHTML = `
                    <div class="task-content" onclick="toggleTask('${task.id}', ${task.done})">
                        <div class="checkbox-custom"></div>
                        ${tagHtml}
                        <span>${task.text}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteTask('${task.id}')">åˆªé™¤</button>
                `;
                list.appendChild(li);
            });
        }, (error) => {
            document.getElementById('status-msg').innerText = "é€£ç·šéŒ¯èª¤: " + error.message;
        });

        window.addTask = function() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            if (!text) return;

            push(tasksRef, {
                text: text,
                weekId: currentWeekID,
                done: false,
                createdAt: Date.now()
            });

            input.value = '';
        }

        window.handleEnter = function(e) {
            if (e.key === 'Enter') addTask();
        }

        window.toggleTask = function(id, currentStatus) {
            update(ref(db, 'tasks/' + id), {
                done: !currentStatus
            });
        }

        window.deleteTask = function(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
                remove(ref(db, 'tasks/' + id));
            }
        }
    </script>
</body>
</html>
